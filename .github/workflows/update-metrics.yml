name: Update GitHub Metrics

on:
  schedule:
    - cron: "0 0 * * *"    # Daily at midnight UTC
  workflow_dispatch:       # Manual trigger for testing

jobs:
  update-metrics:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Verify dependencies
        run: |
          echo "Checking gh CLI..."
          gh --version
          echo "Checking jq..."
          jq --version

      - name: Collect metrics via GraphQL
        env:
          GH_TOKEN: ${{ secrets.METRICS_TOKEN }}
          USERNAME: foyzulkarim
        run: |
          set -e

          echo "Fetching metrics for $USERNAME..."

          # GraphQL query for stars, forks, watchers, repo count, followers
          QUERY='
          query($username: String!, $cursor: String) {
            user(login: $username) {
              followers {
                totalCount
              }
              repositories(first: 100, after: $cursor, ownerAffiliations: OWNER, isFork: false) {
                totalCount
                pageInfo {
                  hasNextPage
                  endCursor
                }
                nodes {
                  name
                  stargazerCount
                  forkCount
                  watchers {
                    totalCount
                  }
                }
              }
            }
          }'

          total_stars=0
          total_forks=0
          total_watchers=0
          total_repos=0
          total_followers=0
          cursor="null"
          page=1

          while true; do
            echo "Fetching page $page..."

            if [ "$cursor" = "null" ]; then
              full_response=$(gh api graphql \
                -f query="$QUERY" \
                -f username="$USERNAME" \
                --jq '.data.user' 2>/dev/null || echo "{}")
              response=$(echo "$full_response" | jq '.repositories')
              # Get followers only on first page
              total_followers=$(echo "$full_response" | jq '.followers.totalCount // 0')
            else
              response=$(gh api graphql \
                -f query="$QUERY" \
                -f username="$USERNAME" \
                -f cursor="$cursor" \
                --jq '.data.user.repositories' 2>/dev/null || echo "{}")
            fi

            # Parse response
            has_next=$(echo "$response" | jq -r '.pageInfo.hasNextPage // false')
            cursor=$(echo "$response" | jq -r '.pageInfo.endCursor // "null"')

            # Set total_repos only once (same value on all pages)
            if [ "$page" -eq 1 ]; then
              total_repos=$(echo "$response" | jq '.totalCount // 0')
            fi

            # Sum metrics from this page
            page_stars=$(echo "$response" | jq '[.nodes[].stargazerCount] | add // 0')
            page_forks=$(echo "$response" | jq '[.nodes[].forkCount] | add // 0')
            page_watchers=$(echo "$response" | jq '[.nodes[].watchers.totalCount] | add // 0')

            total_stars=$((total_stars + page_stars))
            total_forks=$((total_forks + page_forks))
            total_watchers=$((total_watchers + page_watchers))

            echo "  Page $page: +$page_stars stars, +$page_forks forks, +$page_watchers watchers"

            [ "$has_next" = "false" ] && break
            page=$((page + 1))
            sleep 1  # Rate limit protection
          done

          echo ""
          echo "Fetching traffic views..."

          # Get repo names for traffic API (REST only, with pagination)
          total_views=0
          traffic_page=1
          views_data=""

          while true; do
            repos=$(gh api "users/$USERNAME/repos?per_page=100&page=$traffic_page&type=owner" --jq '.[].name' 2>/dev/null || echo "")

            # Break if no repos returned
            [ -z "$repos" ] && break

            for repo in $repos; do
              views=$(gh api "repos/$USERNAME/$repo/traffic/views" --jq '.count // 0' 2>/dev/null || echo "0")
              total_views=$((total_views + views))
              if [ "$views" -gt 0 ]; then
                echo "  $repo: $views views"
                views_data="${views_data}${views} ${repo}"$'\n'
              fi
              sleep 0.5  # Rate limit protection
            done

            # Check if we got less than 100 repos (last page)
            repo_count=$(echo "$repos" | wc -l)
            [ "$repo_count" -lt 100 ] && break

            traffic_page=$((traffic_page + 1))
          done

          # Sort by views (descending) and take top 10
          TOP_REPOS_COUNT=10
          echo ""
          echo "=== Top $TOP_REPOS_COUNT Repositories by Views ==="
          top_repos_table="| Repository | Views |"$'\n'
          top_repos_table+="|------------|-------|"$'\n'

          top_repos=$(echo "$views_data" | sort -t' ' -k1 -nr | head -n $TOP_REPOS_COUNT)
          while IFS= read -r line; do
            [ -z "$line" ] && continue
            repo_views=$(echo "$line" | cut -d' ' -f1)
            repo_name=$(echo "$line" | cut -d' ' -f2-)
            echo "  $repo_name: $repo_views views"
            top_repos_table+="| [$repo_name](https://github.com/$USERNAME/$repo_name) | $repo_views |"$'\n'
          done <<< "$top_repos"

          # Export top repos table (use delimiter for multiline)
          echo "TOP_REPOS_TABLE<<EOF" >> $GITHUB_ENV
          echo "$top_repos_table" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

          echo ""
          echo "=== Final Metrics ==="
          echo "Repositories: $total_repos"
          echo "Stars: $total_stars"
          echo "Forks: $total_forks"
          echo "Watchers: $total_watchers"
          echo "Followers: $total_followers"
          echo "Views (14 days): $total_views"

          # Export to environment
          echo "TOTAL_REPOS=$total_repos" >> $GITHUB_ENV
          echo "TOTAL_STARS=$total_stars" >> $GITHUB_ENV
          echo "TOTAL_FORKS=$total_forks" >> $GITHUB_ENV
          echo "TOTAL_WATCHERS=$total_watchers" >> $GITHUB_ENV
          echo "TOTAL_FOLLOWERS=$total_followers" >> $GITHUB_ENV
          echo "TOTAL_VIEWS=$total_views" >> $GITHUB_ENV
          echo "LAST_UPDATED=$(date -u '+%Y-%m-%d %H:%M UTC')" >> $GITHUB_ENV

      - name: Update README
        run: |
          sed -i "s|<!--TOTAL_REPOS-->.*<!--/TOTAL_REPOS-->|<!--TOTAL_REPOS-->${TOTAL_REPOS}<!--/TOTAL_REPOS-->|" README.md
          sed -i "s|<!--TOTAL_STARS-->.*<!--/TOTAL_STARS-->|<!--TOTAL_STARS-->${TOTAL_STARS}<!--/TOTAL_STARS-->|" README.md
          sed -i "s|<!--TOTAL_FORKS-->.*<!--/TOTAL_FORKS-->|<!--TOTAL_FORKS-->${TOTAL_FORKS}<!--/TOTAL_FORKS-->|" README.md
          sed -i "s|<!--TOTAL_WATCHERS-->.*<!--/TOTAL_WATCHERS-->|<!--TOTAL_WATCHERS-->${TOTAL_WATCHERS}<!--/TOTAL_WATCHERS-->|" README.md
          sed -i "s|<!--TOTAL_FOLLOWERS-->.*<!--/TOTAL_FOLLOWERS-->|<!--TOTAL_FOLLOWERS-->${TOTAL_FOLLOWERS}<!--/TOTAL_FOLLOWERS-->|" README.md
          sed -i "s|<!--TOTAL_VIEWS-->.*<!--/TOTAL_VIEWS-->|<!--TOTAL_VIEWS-->${TOTAL_VIEWS}<!--/TOTAL_VIEWS-->|" README.md
          sed -i "s|<!--LAST_UPDATED-->.*<!--/LAST_UPDATED-->|<!--LAST_UPDATED-->${LAST_UPDATED}<!--/LAST_UPDATED-->|" README.md

          # Replace top repos table (multiline)
          awk -v table="$TOP_REPOS_TABLE" '
            /<!--TOP_REPOS_START-->/ { print; print table; skip=1; next }
            /<!--TOP_REPOS_END-->/ { skip=0 }
            !skip { print }
          ' README.md > README.tmp && mv README.tmp README.md

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if ! git diff --quiet README.md; then
            git add README.md
            git commit -m "chore: update GitHub metrics [skip ci]"
            git push
            echo "README updated successfully!"
          else
            echo "No changes to commit."
          fi
